<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="another hardware blog"><link href=https://yehowshuaimmanuel.com/fpga/verilator/dpi/ rel=canonical><meta name=author content="Yehowshua Immanuel"><meta name=lang:clipboard.copy content="Copy to clipboard"><meta name=lang:clipboard.copied content="Copied to clipboard"><meta name=lang:search.language content=en><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content="No matching documents"><meta name=lang:search.result.one content="1 matching document"><meta name=lang:search.result.other content="# matching documents"><meta name=lang:search.tokenizer content=[\s\-]+><link rel="shortcut icon" href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.1, mkdocs-material-4.6.3"><title>verilator as a nMigen Python backend - planet program</title><link rel=stylesheet href=../../../assets/stylesheets/application.8c7b2d21.css><link rel=stylesheet href=../../../assets/stylesheets/application-palette.6fba2f6a.css><meta name=theme-color content=#fb8c00><script src=../../../assets/javascripts/modernizr.eca31fed.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700%7CUbuntu+Mono&display=fallback"><style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../assets/fonts/material-icons.css><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-144903341-1", "yehowshuaimmanuel.com")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-primary=orange data-md-color-accent=indigo> <svg class=md-svg> <defs> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#adding-verilator-as-a-nmigen-hdl-python-simulator-backend tabindex=0 class=md-skip> Skip to content </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://yehowshuaimmanuel.com/ title="planet program" aria-label="planet program" class="md-header-nav__button md-logo"> <i class=md-icon>videogame_asset</i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> planet program </span> <span class=md-header-nav__topic> verilator as a nMigen Python backend </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input aria-label=search name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> home </a> </li> <li class=md-tabs__item> <a href=../../ class="md-tabs__link md-tabs__link--active"> hardware hacking </a> </li> <li class=md-tabs__item> <a href=../../../mathematics/ellipsoid_indicatrix/ellipsoid_indicatrix/ class=md-tabs__link> mathematics </a> </li> <li class=md-tabs__item> <a href=../../../software_misc/custom_homebrew/cutsom_homebrew/ class=md-tabs__link> software/misc </a> </li> <li class=md-tabs__item> <a href=../../../Bible/Proverbs/14/ class=md-tabs__link> bible notes </a> </li> </ul> </div> </nav> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://yehowshuaimmanuel.com/ title="planet program" class="md-nav__button md-logo"> <i class=md-icon>videogame_asset</i> </a> planet program </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. title=home class=md-nav__link> home </a> </li> <li class=md-nav__item> <a href=../../../about/ title="about me" class=md-nav__link> about me </a> </li> <li class=md-nav__item> <a href=../../../my_setup/hardware/ title="hardware conf" class=md-nav__link> hardware conf </a> </li> <li class=md-nav__item> <a href=../../../my_setup/software/ title="software conf" class=md-nav__link> software conf </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5 checked> <label class=md-nav__link for=nav-5> hardware hacking </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> hardware hacking </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ title="getting started" class=md-nav__link> getting started </a> </li> <li class=md-nav__item> <a href=../../vhdl/getting_started_with_vhdl/ title="FOSS intro to VHDL" class=md-nav__link> FOSS intro to VHDL </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-3 type=checkbox id=nav-5-3 checked> <label class=md-nav__link for=nav-5-3> fpga fun </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-3> fpga fun </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../hdl_wars/ title="hdl wars" class=md-nav__link> hdl wars </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-3-2 type=checkbox id=nav-5-3-2> <label class=md-nav__link for=nav-5-3-2> migen </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-5-3-2> migen </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../migen/why_migen/ title="why migen" class=md-nav__link> why migen </a> </li> <li class=md-nav__item> <a href=../../migen/ethernet_ecp5/ title="ethernet on ECP5" class=md-nav__link> ethernet on ECP5 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-3-3 type=checkbox id=nav-5-3-3 checked> <label class=md-nav__link for=nav-5-3-3> verilator </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-5-3-3> verilator </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../why_verilator/ title="why verilator" class=md-nav__link> why verilator </a> </li> <li class=md-nav__item> <a href=../some_notes_on_verilator/ title="some notes on verilator" class=md-nav__link> some notes on verilator </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> verilator as a nMigen Python backend </label> <a href=./ title="verilator as a nMigen Python backend" class="md-nav__link md-nav__link--active"> verilator as a nMigen Python backend </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#implmenting-dpi class=md-nav__link> Implmenting DPI </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#testv class=md-nav__link> test.v </a> </li> <li class=md-nav__item> <a href=#test_wrapcpp class=md-nav__link> test_wrap.cpp </a> </li> <li class=md-nav__item> <a href=#testv_1 class=md-nav__link> test.v </a> </li> <li class=md-nav__item> <a href=#output class=md-nav__link> output </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-4 type=checkbox id=nav-5-4> <label class=md-nav__link for=nav-5-4> vintage tech projects </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-4> vintage tech projects </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Vintage_Tech/ title="hacking old tech" class=md-nav__link> hacking old tech </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-4-2 type=checkbox id=nav-5-4-2> <label class=md-nav__link for=nav-5-4-2> my classic mac </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-5-4-2> my classic mac </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Vintage_Tech/My_Mac_SE/ title="acquisition and ideas" class=md-nav__link> acquisition and ideas </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-4-3 type=checkbox id=nav-5-4-3> <label class=md-nav__link for=nav-5-4-3> gt retrotech </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-5-4-3> gt retrotech </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Vintage_Tech/retrotech/my_setup/ title="my setup" class=md-nav__link> my setup </a> </li> <li class=md-nav__item> <a href=../../../Vintage_Tech/retrotech/first_steps/ title="first steps" class=md-nav__link> first steps </a> </li> <li class=md-nav__item> <a href=../../../Vintage_Tech/retrotech/la_inspection/ title="la bus inpection" class=md-nav__link> la bus inpection </a> </li> <li class=md-nav__item> <a href=../../../Vintage_Tech/retrotech/why_an_fpga/ title="why an fpga?" class=md-nav__link> why an fpga? </a> </li> <li class=md-nav__item> <a href=../../../Vintage_Tech/retrotech/crt_smoke_test/ title="crt smoke test" class=md-nav__link> crt smoke test </a> </li> <li class=md-nav__item> <a href=../../../Vintage_Tech/retrotech/fpga_logic_analyzer/ title="fpga logic analyzer" class=md-nav__link> fpga logic analyzer </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-6 type=checkbox id=nav-6> <label class=md-nav__link for=nav-6> mathematics </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-6> mathematics </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mathematics/ellipsoid_indicatrix/ellipsoid_indicatrix/ title="Ellipsoid with a=c minor Axis Intersection Invariant Proof Sketch" class=md-nav__link> Ellipsoid with a=c minor Axis Intersection Invariant Proof Sketch </a> </li> <li class=md-nav__item> <a href=../../../mathematics/cube_mesh/cube_mesh/ title="Describing 3d Meshes by Example: Python+JS" class=md-nav__link> Describing 3d Meshes by Example: Python+JS </a> </li> <li class=md-nav__item> <a href=../../../mathematics/elliptically_polarized_efield/efield/ title="elliptically polarized electric field" class=md-nav__link> elliptically polarized electric field </a> </li> <li class=md-nav__item> <a href=../../../mathematics/loss_function_gradient_derivation/ title="loss function gradient derivation" class=md-nav__link> loss function gradient derivation </a> </li> <li class=md-nav__item> <a href=../../../mathematics/EMAG_HW3/EMAG_HW3/ title="goodbye matlab, hello python with emag examples" class=md-nav__link> goodbye matlab, hello python with emag examples </a> </li> <li class=md-nav__item> <a href=../../../mathematics/matlabs_very_real_problems/ title="Matlab's very real problems" class=md-nav__link> Matlab's very real problems </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-7 type=checkbox id=nav-7> <label class=md-nav__link for=nav-7> software/misc </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-7> software/misc </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../software_misc/custom_homebrew/cutsom_homebrew/ title="rolling your own homebrew tap and bottle" class=md-nav__link> rolling your own homebrew tap and bottle </a> </li> <li class=md-nav__item> <a href=../../../software_misc/intro/ title="looking to the future" class=md-nav__link> looking to the future </a> </li> <li class=md-nav__item> <a href=../../../software_misc/on_open_source/ title="thoughts on open source" class=md-nav__link> thoughts on open source </a> </li> <li class=md-nav__item> <a href=../../../software_misc/things_to_learn/ title="things to learn" class=md-nav__link> things to learn </a> </li> <li class=md-nav__item> <a href=../../../software_misc/good_blogs/ title="good blogs" class=md-nav__link> good blogs </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-8 type=checkbox id=nav-8> <label class=md-nav__link for=nav-8> bible notes </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-8> bible notes </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-8-1 type=checkbox id=nav-8-1> <label class=md-nav__link for=nav-8-1> Proverbs </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-8-1> Proverbs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Bible/Proverbs/14/ title="Chapter 14" class=md-nav__link> Chapter 14 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-8-2 type=checkbox id=nav-8-2> <label class=md-nav__link for=nav-8-2> Ezekiel </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-8-2> Ezekiel </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Bible/Ezekiel/3/ title="Chapter 3" class=md-nav__link> Chapter 3 </a> </li> <li class=md-nav__item> <a href=../../../Bible/Ezekiel/13/ title="Chapter 13" class=md-nav__link> Chapter 13 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-8-3 type=checkbox id=nav-8-3> <label class=md-nav__link for=nav-8-3> Matthew </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-8-3> Matthew </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Bible/Matthew/4/ title="Chapter 4" class=md-nav__link> Chapter 4 </a> </li> <li class=md-nav__item> <a href=../../../Bible/Matthew/13/ title="Chapter 13" class=md-nav__link> Chapter 13 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-8-4 type=checkbox id=nav-8-4> <label class=md-nav__link for=nav-8-4> John </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-8-4> John </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Bible/John/15/ title="Chapter 15" class=md-nav__link> Chapter 15 </a> </li> <li class=md-nav__item> <a href=../../../Bible/John/17/ title="Chapter 17" class=md-nav__link> Chapter 17 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-8-5 type=checkbox id=nav-8-5> <label class=md-nav__link for=nav-8-5> Romans </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-8-5> Romans </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Bible/Romans/1/ title="Chapter 1" class=md-nav__link> Chapter 1 </a> </li> <li class=md-nav__item> <a href=../../../Bible/Romans/3/ title="Chapter 3" class=md-nav__link> Chapter 3 </a> </li> <li class=md-nav__item> <a href=../../../Bible/Romans/4/ title="Chapter 4" class=md-nav__link> Chapter 4 </a> </li> <li class=md-nav__item> <a href=../../../Bible/Romans/6/ title="Chapter 6" class=md-nav__link> Chapter 6 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-8-6 type=checkbox id=nav-8-6> <label class=md-nav__link for=nav-8-6> Peter </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-8-6> Peter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Bible/Peter/1/ title="Chapter 1" class=md-nav__link> Chapter 1 </a> </li> <li class=md-nav__item> <a href=../../../Bible/Peter/5/ title="Chapter 5" class=md-nav__link> Chapter 5 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-8-7 type=checkbox id=nav-8-7> <label class=md-nav__link for=nav-8-7> 2 Peter </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-8-7> 2 Peter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Bible/2_Peter/2/ title="Chapter 2" class=md-nav__link> Chapter 2 </a> </li> <li class=md-nav__item> <a href=../../../Bible/2_Peter/3/ title="Chapter 3" class=md-nav__link> Chapter 3 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-8-8 type=checkbox id=nav-8-8> <label class=md-nav__link for=nav-8-8> Revelation </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-8-8> Revelation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../Bible/Revelation/5/ title="Chapter 1" class=md-nav__link> Chapter 1 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>Table of contents</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#implmenting-dpi class=md-nav__link> Implmenting DPI </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#testv class=md-nav__link> test.v </a> </li> <li class=md-nav__item> <a href=#test_wrapcpp class=md-nav__link> test_wrap.cpp </a> </li> <li class=md-nav__item> <a href=#testv_1 class=md-nav__link> test.v </a> </li> <li class=md-nav__item> <a href=#output class=md-nav__link> output </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1 id=adding-verilator-as-a-nmigen-hdl-python-simulator-backend>Adding Verilator as a nMigen-HDL Python Simulator Backend<a class=headerlink href=#adding-verilator-as-a-nmigen-hdl-python-simulator-backend title="Permanent link">&para;</a></h1> <p>Recently, I've been using Migen and nMigen to build hardware for both Nerual Network accelerators and toy GPUs. HDL simulation in both nMigen and Migen currently occurs in pure Python, which is way too slow for simulating operations of high arithmetic intensity such as matrix multiplies.</p> <p>Verilator is the fastest verilog simulator on the market and is also open-source, making it a perfect candidate for an Migen or nMigen backend. I was originally considering implmenting the verilator backend for Migen, but since nMigen improves on the mistakes of Migen(especially in the of clearly defining what is idiomatic nMigen and what is not, I decided to implment the verilator backend for nMigen.</p> <p>One particular advantage of nMigen over Migen is that it retains the hierarchical structure of the HDL AST when emitting verilog. In simulation, nMigen exposes all ports of the top module and submodules. Verilator however does not natively expose its the internals of submodules.</p> <p>Rolling the verilator backend required the following steps:</p> <ol> <li>Compile nMigen top module into verilog</li> <li>Export the relevant ports that the default nMigen simulator would have access too.</li> <li>Generate a wrapper module in verilog that declares DPI setter and getter methods for the nMigen signals of interest.</li> <li>Verilate verilog model and compile verilated into a shared object loaded by Python.</li> </ol> <p>It took quite a while for me to figure out how to implment the DPI methods, so I have pasted what I did below.</p> <p>More information on this <a href=https://github.com/verilator/verilator/issues/2071>here</a>.</p> <h2 id=implmenting-dpi>Implmenting DPI<a class=headerlink href=#implmenting-dpi title="Permanent link">&para;</a></h2> <div class=codehilite><pre><span></span><code>rm -rf obj_dir/
verilator --cc --exe test_wrap.v test.v test.cpp
make -C obj_dir/ -f Vtest_wrap.mk
./obj_dir/Vtest_wrap 
</code></pre></div> <h3 id=testv>test.v<a class=headerlink href=#testv title="Permanent link">&para;</a></h3> <div class=codehilite><pre><span></span><code><span class=k>module</span> <span class=n>t</span> <span class=p>(</span><span class=k>input</span> <span class=p>[</span><span class=mh>71</span><span class=o>:</span><span class=mh>0</span><span class=p>]</span> <span class=n>a</span><span class=p>,</span> <span class=k>output</span> <span class=p>[</span><span class=mh>71</span><span class=o>:</span><span class=mh>0</span><span class=p>]</span> <span class=n>o</span><span class=p>);</span>
   <span class=n>adder</span> <span class=n>add</span> <span class=p>(.</span><span class=n>a</span><span class=p>(</span><span class=n>a</span><span class=p>),</span> <span class=p>.</span><span class=n>b</span><span class=p>(),</span> <span class=p>.</span><span class=n>o</span><span class=p>(</span><span class=n>o</span><span class=p>));</span>
<span class=k>endmodule</span>

<span class=k>module</span> <span class=n>adder</span> <span class=p>(</span><span class=k>input</span> <span class=p>[</span><span class=mh>71</span><span class=o>:</span><span class=mh>0</span><span class=p>]</span> <span class=n>a</span><span class=p>,</span> <span class=k>input</span> <span class=p>[</span><span class=mh>71</span><span class=o>:</span><span class=mh>0</span><span class=p>]</span> <span class=n>b</span><span class=p>,</span> <span class=k>output</span> <span class=p>[</span><span class=mh>71</span><span class=o>:</span><span class=mh>0</span><span class=p>]</span> <span class=n>o</span><span class=p>);</span>
   <span class=k>assign</span> <span class=n>o</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span><span class=p>;</span>
<span class=k>endmodule</span>
</code></pre></div> <h3 id=test_wrapcpp>test_wrap.cpp<a class=headerlink href=#test_wrapcpp title="Permanent link">&para;</a></h3> <div class=codehilite><pre><span></span><code><span class=k>module</span> <span class=n>t_wrap</span> <span class=p>(</span><span class=k>input</span> <span class=p>[</span><span class=mh>71</span><span class=o>:</span><span class=mh>0</span><span class=p>]</span> <span class=n>a</span><span class=p>,</span> <span class=k>output</span> <span class=p>[</span><span class=mh>71</span><span class=o>:</span><span class=mh>0</span><span class=p>]</span> <span class=n>o</span><span class=p>);</span>
   <span class=n>t</span> <span class=n>dut</span> <span class=p>(.</span><span class=n>a</span><span class=p>(</span><span class=n>a</span><span class=p>),</span> <span class=p>.</span><span class=n>o</span><span class=p>(</span><span class=n>o</span><span class=p>));</span>

   <span class=n>export</span> <span class=s>&quot;DPI-C&quot;</span> <span class=k>function</span> <span class=n>read_a</span><span class=p>;</span>
   <span class=k>function</span> <span class=k>void</span> <span class=n>read_a</span><span class=p>(</span><span class=k>output</span> <span class=kt>bit</span> <span class=p>[</span><span class=mh>71</span><span class=o>:</span><span class=mh>0</span><span class=p>]</span> <span class=n>result</span><span class=p>);</span>
       <span class=n>result</span> <span class=o>=</span> <span class=n>dut</span><span class=p>.</span><span class=n>add</span><span class=p>.</span><span class=n>a</span><span class=p>;</span>
   <span class=k>endfunction</span>

   <span class=n>export</span> <span class=s>&quot;DPI-C&quot;</span> <span class=k>function</span> <span class=n>write_a</span><span class=p>;</span>
   <span class=k>function</span> <span class=k>void</span> <span class=n>write_a</span><span class=p>(</span><span class=k>input</span> <span class=kt>bit</span> <span class=p>[</span><span class=mh>71</span><span class=o>:</span><span class=mh>0</span><span class=p>]</span> <span class=n>in</span><span class=p>);</span>
       <span class=n>dut</span><span class=p>.</span><span class=n>add</span><span class=p>.</span><span class=n>a</span> <span class=o>=</span> <span class=n>in</span><span class=p>;</span>
   <span class=k>endfunction</span>

<span class=k>endmodule</span>
</code></pre></div> <h3 id=testv_1>test.v<a class=headerlink href=#testv_1 title="Permanent link">&para;</a></h3> <div class=codehilite><pre><span></span><code><span class=cp>#include</span> <span class=cpf>&quot;Vtest_wrap.h&quot;</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&lt;cstdio&gt;</span><span class=cp></span>

<span class=k>extern</span> <span class=kt>void</span> <span class=nf>write_b</span><span class=p>(</span><span class=kt>char</span><span class=p>);</span>

<span class=kt>void</span> <span class=nf>print_by_int</span><span class=p>(</span><span class=kt>uint32_t</span><span class=o>*</span> <span class=n>val</span><span class=p>){</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&quot;print_by_int</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>);</span>
    <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
        <span class=p>{</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&quot;%d: &quot;</span><span class=p>,</span><span class=n>i</span><span class=p>);</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&quot;%2x</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span><span class=n>val</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
        <span class=p>}</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>**</span> <span class=n>argv</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Vtest_wrap</span> <span class=n>top</span><span class=p>;</span>

    <span class=n>svSetScope</span><span class=p>(</span><span class=n>svGetScopeFromName</span><span class=p>(</span><span class=s>&quot;TOP.t_wrap&quot;</span><span class=p>));</span>

    <span class=c1>//set and read top.a using verilator public method</span>
    <span class=n>top</span><span class=p>.</span><span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=n>top</span><span class=p>.</span><span class=n>a</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
    <span class=n>top</span><span class=p>.</span><span class=n>a</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
    <span class=n>top</span><span class=p>.</span><span class=n>eval</span><span class=p>();</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&quot;from verilator &quot;</span><span class=p>);</span>
    <span class=n>print_by_int</span><span class=p>(</span><span class=n>top</span><span class=p>.</span><span class=n>a</span><span class=p>);</span>

    <span class=c1>//set top.a using DPI and read with DPI</span>
    <span class=kt>uint32_t</span> <span class=n>ret</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>128</span><span class=p>};</span>
    <span class=n>top</span><span class=p>.</span><span class=n>write_a</span><span class=p>((</span><span class=n>svBitVecVal</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>ret</span><span class=p>);</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&quot;from DPI &quot;</span><span class=p>);</span>
    <span class=n>print_by_int</span><span class=p>(</span><span class=n>ret</span><span class=p>);</span>

    <span class=c1>//read top.a with verilator public method - should</span>
    <span class=c1>//match output of DPI</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&quot;from verilator &quot;</span><span class=p>);</span>
    <span class=n>print_by_int</span><span class=p>(</span><span class=n>top</span><span class=p>.</span><span class=n>a</span><span class=p>);</span>

    <span class=n>top</span><span class=p>.</span><span class=k>final</span><span class=p>();</span>
    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <h3 id=output>output<a class=headerlink href=#output title="Permanent link">&para;</a></h3> <div class=codehilite><pre><span></span><code><span class=err>from verilator print_by_int</span>
<span class=c>0:  1</span>
<span class=c>1:  2</span>
<span class=c>2:  3</span>
<span class=err>from DPI print_by_int</span>
<span class=c>0:  0</span>
<span class=c>1:  0</span>
<span class=c>2: 80</span>
<span class=err>from verilator print_by_int</span>
<span class=c>0:  0</span>
<span class=c>1:  0</span>
<span class=c>2: 80</span>
</code></pre></div> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../some_notes_on_verilator/ title="some notes on verilator" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Previous </span> some notes on verilator </span> </div> </a> <a href=../../../Vintage_Tech/ title="hacking old tech" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> Next </span> hacking old tech </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2016 - 2020 Yehowshua Immanuel </div> powered by <a href=https://www.mkdocs.org target=_blank rel=noopener>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../assets/fonts/font-awesome.css> <a href=https://github.com/BracketMaster target=_blank rel=noopener title=github-alt class="md-footer-social__link fa fa-github-alt"></a> <a href=https://www.linkedin.com/in/yehowshua-immanuel/ target=_blank rel=noopener title=linkedin class="md-footer-social__link fa fa-linkedin"></a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/application.8e081faa.js></script> <script>app.initialize({version:"1.1",url:{base:"../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>